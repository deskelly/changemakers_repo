{
	"name": "GA_PageViews_DataFlow",
	"properties": {
		"description": "The derived column and window components have been added to calculated the unique row index i.e rowNumber()",
		"folder": {
			"name": "GoogleAnalytics"
		},
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "GA_PageViews_GetFiles",
						"type": "DatasetReference"
					},
					"name": "SourceProcessFiles"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "GA_PageViews_AzureSqlTable",
						"type": "DatasetReference"
					},
					"name": "sink1"
				}
			],
			"transformations": [],
			"scriptLines": [
				"source(output(",
				"          Column_1 as string,",
				"          Column_2 as string,",
				"          Column_3 as string,",
				"          Column_4 as string,",
				"          Column_5 as string,",
				"          Column_6 as string,",
				"          Column_7 as string,",
				"          Column_8 as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: true,",
				"     skipLines: 7,",
				"     partitionBy('hash', 1)) ~> SourceProcessFiles",
				"SourceProcessFiles sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     deletable:false,",
				"     insertable:true,",
				"     updateable:false,",
				"     upsertable:false,",
				"     format: 'table',",
				"     preSQLs:['drop table if exists Temp_Raw_GA_PageViews;','CREATE TABLE Temp_Raw_GA_PageViews(\\n     Column_1 varchar(128) null\\n     , Column_2 varchar(80) null\\n     , Column_3 varchar(80) null\\n     , Column_4 varchar(80) null\\n     , Column_5 varchar(80) null\\n     , Column_6 varchar(80) null\\n     , Column_7 varchar(80) null\\n     , Column_8 varchar(80) null\\n);'],",
				"     postSQLs:['with field_extract as (\\n    select \\n        *\\n    from Temp_Raw_GA_PageViews\\n    where Column_2 is not null\\n    and trim(Column_1) != \\'Page path and screen class\\'\\n)\\n, date_extract as (\\n    select \\n        dateadd(day, -1, cast(right(trim(Column_1), 8) as datetime)) as date\\n    from Temp_Raw_GA_PageViews\\n    where Column_1 like (\\'# End date:%\\')\\n)\\n, join_extracts as (\\n    select \\n        b.date\\n        , a.Column_1 as \\'Page path and screen class\\'\\n        , a.Column_2 as \\'Views\\'\\n        , a.Column_3 as \\'Users\\'\\n        , a.Column_4 as \\'Views per user\\'\\n        , a.Column_5 as \\'Average engagement time\\'\\n        , a.Column_6 as \\'Event count\\'\\n        , a.Column_7 as \\'Conversions\\'\\n        , a.Column_8 as \\'Total revenue\\'\\nfrom field_extract a\\ncross join date_extract b\\n)\\n, final_table as (\\n    select \\n        date\\n        , sum(cast([Event count] as int)) as impressions\\n        , sum(cast(Users as int)) as users\\n        , sum(cast([Average engagement time] as decimal)) as time_spent_on_site_page_podcast_vodcast\\n    from join_extracts\\n    group by date\\n)\\n-- select * from final_table\\n\\nMERGE INTO Changemakers_Combined_Overview a\\nUSING final_table b\\n    ON a.channel = \\'Search\\' \\n    and a.sub_channel = \\'Google Analytics\\'\\n    and a.date = b.date \\nWHEN MATCHED THEN\\n  UPDATE SET \\n        a.impressions  = b.impressions \\n        , a.users = b.users\\n        , a.time_spent_on_site_page_podcast_vodcast = b.time_spent_on_site_page_podcast_vodcast\\nWHEN NOT MATCHED THEN\\n  INSERT (channel,sub_channel,content, date, month, month_year, week, day_week, week_type, time_day,impressions,users,time_spent_on_site_page_podcast_vodcast)\\n  VALUES (\\n        \\'Search\\'\\n        , \\'Google Analytics\\'\\n        , \\'Unspecified\\'\\n        , b.date\\n        , datename(month, b.date)\\n        , concat(datename(month, b.date), \\' \\', year(b.date))\\n        , concat(datename(month, b.date), \\' \\', year(b.date), \\' Week \\', (DATEPART(week, b.date) - DATEPART(week, DATEADD(day, 1, EOMONTH(b.date, -1)))) + 1)\\n        , datename(dw, b.date)\\n        , case when datename(dw, b.date) in (\\'Saturday\\', \\'Sunday\\') then \\'Weekend\\' else \\'Weekday\\' end\\n        , \\'Unspecified\\'\\n        , b.impressions\\n        , b.users\\n        , b.time_spent_on_site_page_podcast_vodcast\\n        );','drop table if exists Temp_Raw_GA_PageViews;'],",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     errorHandlingOption: 'stopOnFirstError') ~> sink1"
			]
		}
	}
}